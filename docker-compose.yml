version: "3.7"

services:
  nginx:
    build:
      context: .
      dockerfile: nginx/nginx.Dockerfile
    volumes:
      - ./www:/var/www/html:cached
      - ./nginx/log:/var/log/nginx
    ports:
      - 80:80
    links:
      - fpm
      - mongo
      - mongo-express
      - beanstalkd
    depends_on:
      - fpm
    container_name: 'autoparts_nginx'

  fpm:
    #image: php:7.2-fpm-alpine
    build:
      context: .
      dockerfile: fpm/.Dockerfile
    environment:
      APP_ENV: dev
    ports:
      - '9000:9000'
    volumes:
      - ./www:/var/www/html
      #- ./fpm/php.ini:/usr/local/etc/php/php.ini
      #- ./fpm/ssmtp.conf:/etc/ssmtp/ssmtp.conf
      #- ./fpm/revaliases:/etc/ssmtp/revaliases
      #- ./cron/docker.sock:/var/run/docker.sock
    links:
      - mongo
      - beanstalkd
    depends_on:
      - mongo
    container_name: 'autoparts_fpm'
  mongo:
    image: mongo
    volumes:
      - './mongo/data:/data/db'
    restart: "no"
    environment:
      MONGO_INITDB_ROOT_USERNAME: root
      MONGO_INITDB_ROOT_PASSWORD: root
  mongo-express:
    image: mongo-express
    restart: "no"
    ports:
      - 8081:8081
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: root
      ME_CONFIG_MONGODB_ADMINPASSWORD: root
    container_name: 'autoparts_express'
    depends_on:
      - mongo
  #rabbitmq:
  #  image: 'rabbitmq:3.6-management-alpine'
  #  ports:
  #    - '5672:5672'
  #    - '15672:15672'
  #  volumes:
  #    - ./rabbit:/var/lib/rabbitmq
  beanstalkd:
    image: schickling/beanstalkd:latest
    restart: always
    ports:
      - "11300:11300"
  beanstalkd_console:
    ## Optionally; you can use a ready image changing:
    ## * `build: .`
    ## into:
    image: agaveapi/beanstalkd-console
    ports:
      - 11380:80
    environment:
      - BEANSTALKD_HOST=beanstalkd
    links:
      - beanstalkd
